services:
  browser:
    build:
      context: ./docker/browser
      dockerfile: Dockerfile
    container_name: automation-browser
    environment:
      - VNC_PASSWORD=${VNC_PASSWORD:-secret}
      - RESOLUTION=${RESOLUTION:-1920x1080x24}
      - DISPLAY=:99
      - INSTALL_UBLOCK=${INSTALL_UBLOCK:-true}
    ports:
      - "${NOVNC_PORT:-6080}:6080"   # noVNC web interface
      - "${VNC_PORT:-5900}:5900"     # VNC
      - "${CDP_PORT:-9222}:9222"     # Chrome DevTools Protocol
    volumes:
      - ./tmp:/app/tmp
      - ./tmp/sessions:/app/sessions
      - /dev/shm:/dev/shm
    networks:
      - automation-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6080"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  video:
    image: selenium/video:ffmpeg-7.1-20250515
    container_name: automation-video
    environment:
      - DISPLAY_CONTAINER_NAME=automation-browser
      - FILE_NAME=recording.mp4
      - VIDEO_SIZE=${VIDEO_SIZE:-1920x1080}
      - FRAME_RATE=${FRAME_RATE:-15}
    volumes:
      - ./tmp/videos:/videos
    depends_on:
      browser:
        condition: service_healthy
    networks:
      - automation-net

  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: automation-tunnel
    command: tunnel --no-autoupdate --url http://browser:6080
    depends_on:
      browser:
        condition: service_healthy
    networks:
      - automation-net
    profiles:
      - tunnel

  # ML Inference Services (use --profile ml to start)
  omniparser:
    build:
      context: ./docker/omniparser
      dockerfile: Dockerfile
    container_name: automation-omniparser
    ports:
      - "${OMNIPARSER_PORT:-8010}:8000"
    volumes:
      - ./tmp/omniparser:/app/output
      - omniparser-weights:/app/weights
    networks:
      - automation-net
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    healthcheck:
      test: ["CMD", "python3", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 180s
    profiles:
      - ml

  gui-actor:
    build:
      context: ./docker/gui-actor
      dockerfile: Dockerfile
    container_name: automation-gui-actor
    ports:
      - "${GUI_ACTOR_PORT:-8001}:8001"
    volumes:
      - gui-actor-models:/app/models
    networks:
      - automation-net
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    healthcheck:
      test: ["CMD", "python3", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8001/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 300s
    profiles:
      - ml

networks:
  automation-net:
    driver: bridge

volumes:
  omniparser-weights:
  gui-actor-models:
